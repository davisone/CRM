generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  COMMERCIAL
  TELEPROSPECTEUR
}

enum ProspectStatus {
  NOUVEAU
  A_CONTACTER
  CONTACTE
  INTERESSE
  A_RELANCER
  CLIENT
  NON_INTERESSE
  PERDU
  NE_PLUS_CONTACTER
}

enum ActivityType {
  APPEL
  EMAIL
  NOTE
  RELANCE
  CHANGEMENT_STATUT
  ENRICHISSEMENT
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  passwordHash  String
  role          UserRole  @default(TELEPROSPECTEUR)
  isActive      Boolean   @default(true)
  maxProspects  Int       @default(100)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  prospects     Prospect[]
  activities    Activity[]

  @@map("users")
}

model Prospect {
  id                String          @id @default(cuid())
  siren             String          @unique
  siret             String?
  companyName       String
  legalForm         String?
  nafCode           String?
  nafLabel          String?
  address           String?
  postalCode        String?
  city              String?
  region            String?
  creationDate      DateTime?
  employeeCount     Int?
  revenue           Float?
  website           String?
  websiteQuality    Int?
  phone             String?
  email             String?
  googleRating      Float?
  googlePlaceId     String?
  hasGooglePresence Boolean         @default(false)

  score             Int             @default(0)
  scoringDetails    Json?
  priority          Int             @default(5)
  status            ProspectStatus  @default(NOUVEAU)

  assignedToId      String?
  assignedTo        User?           @relation(fields: [assignedToId], references: [id])
  assignedAt        DateTime?

  importBatchId     String?
  importBatch       ImportBatch?    @relation(fields: [importBatchId], references: [id])

  lastContactedAt   DateTime?
  nextFollowUpAt    DateTime?
  followUpNote      String?

  rgpdOptOut        Boolean         @default(false)
  rgpdOptOutDate    DateTime?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  directors         Director[]
  activities        Activity[]
  statusHistory     ProspectStatusHistory[]
  enrichmentLogs    EnrichmentLog[]

  @@index([status])
  @@index([assignedToId])
  @@index([score])
  @@index([postalCode])
  @@index([nafCode])
  @@index([nextFollowUpAt])
  @@map("prospects")
}

model Director {
  id          String   @id @default(cuid())
  firstName   String?
  lastName    String
  role        String?
  birthDate   DateTime?
  phone       String?
  email       String?
  linkedin    String?

  prospectId  String
  prospect    Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("directors")
}

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  title       String
  content     String?
  metadata    Json?

  prospectId  String
  prospect    Prospect     @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  userId      String
  user        User         @relation(fields: [userId], references: [id])

  scheduledAt DateTime?
  completedAt DateTime?

  createdAt   DateTime     @default(now())

  @@index([prospectId])
  @@index([userId])
  @@index([scheduledAt])
  @@map("activities")
}

model ProspectStatusHistory {
  id          String         @id @default(cuid())
  fromStatus  ProspectStatus?
  toStatus    ProspectStatus
  reason      String?

  prospectId  String
  prospect    Prospect       @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  changedBy   String?

  createdAt   DateTime       @default(now())

  @@index([prospectId])
  @@map("prospect_status_history")
}

model EnrichmentLog {
  id          String   @id @default(cuid())
  source      String
  endpoint    String?
  success     Boolean
  httpStatus  Int?
  responseMs  Int?
  error       String?
  dataKeys    String[]
  creditsUsed Int      @default(0)

  prospectId  String
  prospect    Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([prospectId])
  @@index([source])
  @@map("enrichment_logs")
}

model ImportBatch {
  id              String   @id @default(cuid())
  source          String   @default("INPI")
  totalFound      Int      @default(0)
  newInserted     Int      @default(0)
  duplicatesSkipped Int    @default(0)
  enriched        Int      @default(0)
  scored          Int      @default(0)
  assigned        Int      @default(0)
  errors          Int      @default(0)
  status          String   @default("PENDING")
  errorDetails    Json?

  prospects       Prospect[]

  startedAt       DateTime @default(now())
  completedAt     DateTime?

  @@map("import_batches")
}

model NafSection {
  id          String  @id @default(cuid())
  code        String  @unique
  label       String
  scoreBonus  Int     @default(0)
  isHighValue Boolean @default(false)

  @@map("naf_sections")
}

model SystemSetting {
  id    String @id @default(cuid())
  key   String @unique
  value String
  type  String @default("string")

  updatedAt DateTime @updatedAt

  @@map("system_settings")
}
